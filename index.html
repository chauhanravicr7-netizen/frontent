<script>
    const API_URL = 'https://dockside-api.onrender.com';

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('loginBtn');
        const status = document.getElementById('status');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        btn.disabled = true;
        status.innerText = "ESTABLISHING SECURE CONNECTION...";

        // SMART RETRY LOGIC
        const attemptLogin = async (retries = 3) => {
            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('email', email);
                    renderDashboard(email);
                } else {
                    const errorData = await res.json();
                    alert(errorData.error || "Invalid Credentials");
                    resetBtn(btn, status);
                }
            } catch (err) {
                if (retries > 0) {
                    status.innerText = `RETRYING CONNECTION (${retries} attempts left)...`;
                    setTimeout(() => attemptLogin(retries - 1), 5000); // Wait 5s then retry
                } else {
                    alert("Connection Refused. Please ensure Step 1 (CORS update) is done in your backend.");
                    resetBtn(btn, status);
                }
            }
        };

        attemptLogin();
    });

    function resetBtn(btn, status) {
        btn.disabled = false;
        btn.innerText = "LOGIN";
        status.innerText = "SYSTEM READY â€¢ GANDHIDHAM HUB";
    }
</script>
